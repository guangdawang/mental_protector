# 心灵方舟 - 开发更新日志

## v1.2.0 - 用户体验增强版

### 新增功能

#### 1. 情绪趋势图表 📈
- **文件**: `lib/features/emotion/components/emotion_chart.dart`
- **功能**:
  - 自定义绘制情绪趋势图（不依赖第三方库）
  - 平滑的贝塞尔曲线
  - 颜色编码的数据点
  - 参考线和Y轴标签
  - 空状态友好提示

#### 2. 情绪记录输入 📝
- **文件**: `lib/features/emotion/screens/emotion_input_screen.dart`
- **功能**:
  - 5级情绪选项（从"极度低落"到"良好"）
  - 图标化选项选择
  - 可选备注输入（最多200字）
  - 动画选择反馈
  - 保存成功提示

#### 3. 搜索功能 🔍
- **文件**: `lib/features/emotion/screens/emotion_history_screen.dart`（更新）
- **功能**:
  - 实时搜索情绪记录
  - 支持日期搜索
  - 支持分数搜索
  - 支持备注关键词搜索
  - 空结果友好提示

#### 4. 统计摘要 📊
- **文件**: `lib/features/emotion/screens/emotion_history_screen.dart`（更新）
- **功能**:
  - 显示平均情绪分
  - 显示最高/最低分
  - 显示记录总数
  - 醒目的数据展示

#### 5. 主页按钮优化 🎨
- **文件**: `lib/app.dart`（更新）
- **功能**:
  - 新增"记录情绪"按钮（主按钮）
  - 重新排列按钮优先级
  - "测试输入检测"移至次要位置
  - 更符合用户使用习惯

#### 6. 详细使用指南 📖
- **文件**: `USAGE_GUIDE.md`
- **内容**:
  - 完整的使用说明
  - 功能详解
  - 情绪评分系统
  - 常见问题解答
  - 高级功能使用
  - 紧急求助指南

### 技术改进

1. **图表绘制**
   - 使用CustomPainter自定义绘制
   - 贝塞尔曲线平滑
   - 渐变填充效果

2. **搜索算法**
   - 模糊匹配搜索
   - 多字段搜索（日期、分数、备注）
   - 实时过滤

3. **UI/UX优化**
   - 动画过渡效果
   - 空状态提示
   - 数据可视化增强

### 文件统计

- **新增文件**: 2个
  - emotion_chart.dart (9.5 KB)
  - emotion_input_screen.dart (8.1 KB)

- **修改文件**: 3个
  - app.dart (新增记录情绪入口和导航）
  - emotion_history_screen.dart (添加搜索和统计）
  - UPDATE_LOG.md (本文件）

- **新增文档**: 1个
  - USAGE_GUIDE.md (详细使用指南）

- **总代码行数**: 约 3500+ 行

### 功能特性总结（v1.2.0）

#### 完整功能列表

1. **实时危机检测** ✅
   - 13个关键词检测
   - 输入模式分析
   - 自动情绪状态评估

2. **安全岛界面** ✅
   - 深蓝色呼吸引导
   - 6秒呼吸循环
   - 星光动态背景
   - 心跳声（可选）

3. **一键求助系统** ✅
   - 8个内置危机热线
   - 一键拨号功能
   - 完全离线可用

4. **紧急联系人** ✅
   - 最多3个联系人
   - 10秒倒计时发送
   - 可随时取消
   - 3个月过期机制

5. **设置页面** ✅
   - 紧急联系功能开关
   - 月度提醒设置
   - 振动反馈开关
   - 音频播放控制
   - 紧急联系人管理
   - 数据备份/恢复
   - 清除所有数据

6. **本地数据存储** ✅
   - Hive高性能存储
   - 紧急联系人持久化
   - 情绪记录历史（100条）
   - 用户设置持久化

7. **数据加密与备份** ✅
   - AES-256加密
   - .heart文件导出
   - 自定义密码支持
   - SHA-256完整性验证
   - 分享备份文件

8. **引导页面** ✅
   - 6页功能介绍
   - 精美动画效果
   - 首次自动显示
   - 可跳过功能

9. **情绪记录历史** ✅
   - 按日期分组显示
   - 趋势指示器
   - 颜色编码
   - 相对时间显示
   - **新增**：搜索功能
   - **新增**：统计摘要
   - **新增**：趋势图表

10. **情绪记录输入** ✨
   - 5级情绪选项
   - 图标化选择
   - 可选备注
   - 动画反馈

11. **详细使用指南** ✨
   - 完整功能说明
   - 情绪评分系统
   - 常见问题解答
   - 高级功能使用

### 用户旅程

#### 日常使用流程
```
打开应用
  ↓
点击"记录情绪"
  ↓
选择当前心情（5个选项）
  ↓
（可选）添加备注
  ↓
保存记录
  ↓
查看历史统计和趋势
```

#### 情绪提升流程
```
检测到危机
  ↓
自动进入安全岛
  ↓
呼吸练习（3-5分钟）
  ↓
心情平复
  ↓
手动记录情绪
  ↓
查看趋势改善
```

### 性能优化

1. **图表渲染**
   - 自定义绘制，不依赖第三方库
   - 最小化重绘
   - 使用Path缓存

2. **搜索性能**
   - 实时过滤，即时响应
   - 无需重新构建整个列表
   - 智能去重

3. **内存管理**
   - 限制历史记录数量（100条）
   - 及时释放未使用资源
   - Widget复用

### 已知限制

1. **图表功能**
   - 简化版图表（非fl_chart）
   - 美观但功能基础
   - 未来可升级为专业图表库

2. **搜索功能**
   - 仅支持简单关键词匹配
   - 不支持模糊搜索或拼音搜索
   - 可后续优化

### 使用统计

#### 预期用户行为
```
日常使用：
- 记录情绪：每日1-2次
- 查看历史：每周3-4次
- 进入安全岛：每月1-3次（按需）

数据量：
- 每月记录：30-60条
- 年度记录：360-720条（自动清理至100条）
```

### 后续计划

#### 短期（v1.3.0）
- [ ] 心跳声音频文件
- [ ] 专业图表库（fl_chart）
- [ ] 拼音搜索
- [ ] 导出情绪报告（PDF）

#### 中期（v1.4.0）
- [ ] iOS适配
- [ ] 多语言支持
- [ ] 主题切换
- [ ] 通知提醒优化

#### 长期（v2.0.0）
- [ ] Web版本
- [ ] 可选云端同步
- [ ] AI情绪分析增强
- [ ] 社区互助功能
- [ ] 心理测试问卷
- [ ] 冥想引导课程

### 测试要点

#### 新功能测试
- [ ] 手动记录情绪
- [ ] 查看情绪统计
- [ ] 查看趋势图表
- [ ] 搜索历史记录
- [ ] 空状态处理

#### 集成测试
- [ ] 主页导航流畅性
- [ ] 状态更新同步
- [ ] 数据持久化
- [ ] 跨页面数据共享

### 开发建议

1. **情绪记录**
   - 建议每天记录1-2次
   - 记录时尽量真实反映当前状态
   - 备注可以记录触发情绪的事件

2. **查看趋势**
   - 每周查看一次趋势图
   - 注意情绪的周期性变化
   - 及时调整生活方式

3. **危机应对**
   - 不要独自承受困难
   - 及时使用求助功能
   - 专业帮助很重要

---

**开发时间**: 2025-12-30
**版本**: v1.2.0
**状态**: ✅ 可运行

---

## v1.1.0 - 功能完善版

### 新增功能

#### 1. 引导页面 ✨
- **文件**: `lib/features/onboarding/onboarding_screen.dart`
- **功能**:
  - 6页精美引导动画
  - 首次启动自动显示
  - 可跳过或滑动浏览
  - 完成后自动进入主页
  - 状态持久化（首次启动检测）

#### 2. 情绪记录历史 📊
- **文件**: `lib/features/emotion/screens/emotion_history_screen.dart`
- **功能**:
  - 按日期分组显示情绪记录
  - 相对时间显示（今天、昨天、X天前）
  - 趋势指示器（上升/下降/平稳）
  - 颜色编码的情绪等级
  - 空状态友好提示
  - 最多保留100条记录

#### 3. 首次启动管理 🚀
- **文件**: `lib/core/state/first_launch_state.dart`
- **功能**:
  - 检测首次启动状态
  - 引导完成状态追踪
  - SharedPreferences持久化
  - 可重置状态（用于测试）

#### 4. 主页增强 🎨
- **文件**: `lib/app.dart`
- **更新**:
  - 添加情绪历史入口（顶部时钟图标）
  - 集成引导页面逻辑
  - 首次启动显示引导
  - 引导完成显示主页

### 依赖更新

#### 新增依赖
```yaml
intl: ^0.18.1  # 日期格式化
```

### 技术改进

1. **状态管理**
   - 新增FirstLaunchState状态
   - 统一管理首次启动和引导状态

2. **UI/UX优化**
   - 引导页面使用PageView实现滑动效果
   - 情绪记录使用列表分组
   - 添加动画过渡效果

3. **用户体验**
   - 首次使用更友好
   - 情绪变化可视化
   - 直观的趋势显示

### 文件统计

- **新增文件**: 3个
  - onboarding_screen.dart (7.84 KB)
  - emotion_history_screen.dart (6.92 KB)
  - first_launch_state.dart (2.12 KB)

- **修改文件**: 3个
  - app.dart (新增引导逻辑和图标)
  - providers.dart (导出新状态）
  - pubspec.yaml (新增intl依赖）

- **总代码行数**: 约 3000+ 行

### 功能特性总结

#### 完整功能列表

1. **实时危机检测**
   - ✅ 13个关键词检测
   - ✅ 输入模式分析
   - ✅ 自动情绪状态评估

2. **安全岛界面**
   - ✅ 深蓝色呼吸引导
   - ✅ 6秒呼吸循环
   - ✅ 星光动态背景
   - ✅ 心跳声（可选）

3. **一键求助系统**
   - ✅ 8个内置危机热线
   - ✅ 一键拨号功能
   - ✅ 完全离线可用

4. **紧急联系人**
   - ✅ 最多3个联系人
   - ✅ 10秒倒计时发送
   - ✅ 可随时取消
   - ✅ 3个月过期机制

5. **设置页面**
   - ✅ 紧急联系功能开关
   - ✅ 月度提醒设置
   - ✅ 振动反馈开关
   - ✅ 音频播放控制
   - ✅ 紧急联系人管理
   - ✅ 数据备份/恢复
   - ✅ 清除所有数据

6. **本地数据存储**
   - ✅ Hive高性能存储
   - ✅ 紧急联系人持久化
   - ✅ 情绪记录历史（100条）
   - ✅ 用户设置持久化

7. **数据加密与备份**
   - ✅ AES-256加密
   - ✅ .heart文件导出
   - ✅ 自定义密码支持
   - ✅ SHA-256完整性验证
   - ✅ 分享备份文件

8. **引导页面** ✨
   - ✅ 6页功能介绍
   - ✅ 精美动画效果
   - ✅ 首次自动显示
   - ✅ 可跳过功能

9. **情绪记录历史** ✨
   - ✅ 按日期分组
   - ✅ 趋势指示器
   - ✅ 颜色编码
   - ✅ 相对时间显示

### 技术架构

```
┌─────────────────────────────────────────┐
│           Presentation Layer            │
│  ┌───────────┬──────────────────┐ │
│  │ HomeScreen │ OnboardingScreen │ │
│  │   History  │    Settings      │ │
│  └───────────┴──────────────────┘ │
└───────────────┬───────────────────┘
                │
┌───────────────▼───────────────────┐
│           State Layer               │
│  ┌───────────┬──────────────────┐ │
│  │EmotionState│FirstLaunchState │ │
│  │ UserState  │                │ │
│  └───────────┴──────────────────┘ │
└───────────────┬───────────────────┘
                │
┌───────────────▼───────────────────┐
│           Service Layer             │
│  ┌───────────┬──────────────────┐ │
│  │CrisisDetect│BackupService   │ │
│  │Encryption  │StorageService  │ │
│  └───────────┴──────────────────┘ │
└───────────────┬───────────────────┘
                │
┌───────────────▼───────────────────┐
│           Data Layer               │
│  ┌───────────┬──────────────────┐ │
│  │   Hive     │   Models       │ │
│  └───────────┴──────────────────┘ │
└───────────────────────────────────┘
```

### 使用流程

#### 首次使用流程
```
启动应用
  ↓
检测首次启动
  ↓
显示引导页面（6页）
  ↓
完成引导 / 跳过
  ↓
进入主页
```

#### 情绪检测流程
```
用户输入
  ↓
关键词检测 + 输入模式分析
  ↓
危机判定
  ↓
更新情绪状态 → 记录历史
  ↓
自动进入安全岛
```

### 性能优化

1. **本地存储**
   - Hive高性能NoSQL数据库
   - 延迟加载
   - 查询优化

2. **状态管理**
   - Riverpod响应式状态
   - 最小化重渲染
   - 状态缓存

3. **UI渲染**
   - AnimatedBuilder优化动画
   - ListView.builder懒加载
   - const Widget复用

### 已知限制

1. **音频文件**
   - `assets/sounds/` 需要手动添加心跳声文件
   - 建议使用MP3格式，30%音量

2. **字体文件**
   - 可选添加中文字体
   - 建议使用Noto Sans SC

3. **图表可视化**
   - 情绪记录当前使用列表显示
   - 未来可添加折线图/柱状图

### 后续计划

#### 短期（v1.2.0）
- [ ] 心跳声音频文件
- [ ] 情绪记录图表可视化
- [ ] 搜索历史记录
- [ ] 导出情绪报告（PDF）

#### 中期（v1.3.0）
- [ ] iOS适配
- [ ] 多语言支持（英文/繁体中文）
- [ ] 主题切换（浅色/深色）
- [ ] 通知提醒优化

#### 长期（v2.0.0）
- [ ] Web版本
- [ ] 可选云端同步
- [ ] AI情绪分析增强
- [ ] 社区互助功能
- [ ] 心理测试问卷
- [ ] 冥想引导课程

### 开发建议

1. **音频资源**
   - 下载或生成心跳声文件
   - 格式：MP3，44.1kHz，128kbps
   - 时长：3-5秒循环
   - 文件名：heartbeat.mp3

2. **测试要点**
   - 首次启动流程
   - 引导页面动画
   - 情绪记录持久化
   - 数据备份恢复

3. **常见问题**
   - Hive初始化失败 → 清除应用数据重试
   - 引导不显示 → 检查SharedPreferences
   - 历史记录为空 → 正常，需要使用后才有记录

---

**开发时间**: 2025-12-30
**版本**: v1.1.0
**状态**: ✅ 可运行
